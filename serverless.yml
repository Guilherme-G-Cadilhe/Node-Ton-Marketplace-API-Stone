service: ton-marketplace-api

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'} # Define o ambiente (dev, hml, prod)

  tracing:
    lambda: true
    apiGateway: true

  environment:
    TABLE_NAME: ${self:custom.tableName}
    JWT_SECRET: "DESAFIO_STONE"

  # -----------------------------------------------------------------
  # ⬇️ PERMISSÕES PARA DEPLOY NA AWS ⬇️
  # Este bloco é NECESSÁRIO para o deploy na AWS, mas DEVE
  # ser comentado para o 'serverless offline' funcionar
  # sem credenciais AWS válidas.
  # -----------------------------------------------------------------
  # iam:
  #   role:
  #     statements:
  #       - Effect: "Allow"
  #         Action:
  #           # Permissão do authLogin (src/repositories/user-repository.ts)
  #           - "dynamodb:GetItem"
  #           # Permissões do getProducts (src/repositories/product-repository.ts)
  #           - "dynamodb:Query"
  #           # Permissões do Rate Limiter (src/services/rate-limiter.ts)
  #           - "dynamodb:UpdateItem" # GetItem já está coberto acima
  #         Resource:
  #           # Permissão para a tabela principal
  #           - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.tableName}"
  # -----------------------------------------------------------------
  httpApi:
    authorizers:
      jwtAuthorizer:
        type: request
        functionName: jwtAuthorizer
        identitySource:
          - "$request.header.Authorization" # token JWT
        enableSimpleResponses: true # Retorna 401/403 simples

plugins:
  - serverless-esbuild # Compila TS
  - serverless-offline # Roda a API localmente
  - serverless-openapi-documenter # Documenta a API

package:
  individually: true # Otimiza o tamanho de cada Lambda

# Variáveis customizadas
custom:
  tableName: ton-marketplace-api-${self:provider.stage} # ex: ton-marketplace-api-dev
  esbuild:
    bundle: true
    minify: false # Deixe false para debug mais fácil
    sourcemap: true
    exclude:
      - "@aws-sdk/*" # Já existe no runtime do Lambda
    target: "node20"
    platform: "node"
    concurrency: 10

  documentation:
    version: "1.0.0"
    title: "Ton Marketplace API"
    description: "API para o desafio SWE da Stone (Ton/Renda Extra)"
    models:
      - name: "ErrorResponse"
        description: "Resposta de erro padrão"
        schema:
          type: "object"
          properties:
            message: { type: "string" }

      - name: "LoginRequest"
        description: "Payload para o endpoint de login"
        schema:
          type: "object"
          properties:
            email: { type: "string", example: "teste@ton.com" }
            password: { type: "string", example: "senha123" }

      - name: "LoginResponse"
        description: "Resposta do login bem-sucedido"
        schema:
          type: "object"
          properties:
            token: { type: "string" }
            expiresIn: { type: "integer" }

      - name: "Product"
        description: "Objeto de produto"
        schema:
          type: "object"
          properties:
            PK: { type: "string" }
            SK: { type: "string" }
            name: { type: "string" }
            description: { type: "string" }
            price: { type: "number" }
            category: { type: "string" }

      - name: "Pagination"
        description: "Metadados de paginação"
        schema:
          type: "object"
          properties:
            limit: { type: "integer" }
            hasNext: { type: "boolean" }
            nextCursor: { type: "string", nullable: true }

      - name: "ListProductsResponse"
        description: "Resposta da listagem de produtos"
        schema:
          type: "object"
          properties:
            data:
              type: "array"
              items:
                $ref: "#/components/schemas/Product"
            pagination:
              $ref: "#/components/schemas/Pagination"

# Lambdas e endpoints
functions:
  healthCheck:
    handler: src/handlers/health.check # O caminho para a função (arquivo health.ts, função 'check')
    events:
      - httpApi:
          path: /health
          method: GET

  authLogin:
    handler: src/handlers/auth.login # Aponta para o arquivo 'auth.ts', função 'login'
    events:
      - httpApi:
          path: /auth/login
          method: POST
          documentation:
            summary: "Autentica um usuário"
            description: "Realiza o login via email e senha e retorna um token JWT."
            requestBody:
              description: "Credenciais do usuário"
            requestModels:
              "application/json": "LoginRequest" # (Usa a chave do 'models' acima)
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: "Login bem-sucedido"
                responseModels:
                  "application/json": "LoginResponse"
              - statusCode: 401
                responseBody:
                  description: "Email ou senha inválidos"
                responseModels:
                  "application/json": "ErrorResponse"

  jwtAuthorizer:
    handler: src/authorizers/jwt.handler # Aponta para o arquivo 'jwt.ts', função 'handler'

  getProducts:
    handler: src/handlers/products.list # Aponta para 'products.ts', função 'list'
    events:
      - httpApi:
          path: /products
          method: GET
          authorizer:
            name: jwtAuthorizer
          documentation:
            summary: "Lista produtos com paginação"
            description: "Retorna uma lista paginada de produtos. Requer token JWT."
            # (Este plugin entende o 'authorizer:' automaticamente)
            queryParams:
              - name: limit
                description: "Número de itens por página"
                schema:
                  type: "integer"
                  default: 20
              - name: cursor
                description: "Cursor (Base64) para a próxima página"
                schema:
                  type: "string"
            methodResponses:
              - statusCode: 200
                responseBody:
                  description: "Lista de produtos"
                responseModels:
                  "application/json": "ListProductsResponse"
              - statusCode: 401
                description: "Token JWT inválido ou ausente"
              - statusCode: 429
                description: "Too Many Requests (Rate Limit)"

# Recursos de infra
resources:
  Resources:
    # Definição da tabela DynamoDB
    TonMarketplaceTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableName}
        BillingMode: PAY_PER_REQUEST # Custo por requisição (bom para serverless)

        # Estas são as chaves da nossa Single-Table
        # PK = Partition Key (Chave de Partição)
        # SK = Sort Key (Chave de Ordenação)
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S # S = String
          - AttributeName: SK
            AttributeType: S

        KeySchema:
          - AttributeName: PK
            KeyType: HASH # HASH = Chave de Partição
          - AttributeName: SK
            KeyType: RANGE # RANGE = Chave de Ordenação
